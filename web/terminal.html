<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ker.ai</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:#0d1117;color:#c9d1d9;font-family:'SF Mono','Cascadia Code','Fira Code',monospace;font-size:14px}
body{display:flex;flex-direction:column}
#output{flex:1;overflow-y:auto;padding:12px 16px;white-space:pre-wrap;word-break:break-all}
.line-input{color:#c9d1d9}.line-output{color:#7ee787}.line-error{color:#f85149}
.line-info{color:#58a6ff}
#input-row{display:flex;align-items:center;padding:4px 16px 8px;border-top:1px solid #21262d;background:#0d1117}
#prompt{color:#58a6ff;margin-right:8px;white-space:nowrap;user-select:none}
#input{flex:1;background:transparent;border:none;outline:none;color:#c9d1d9;font:inherit;caret-color:#58a6ff}
#status{display:flex;justify-content:space-between;padding:2px 16px;background:#161b22;border-top:1px solid #21262d;font-size:12px;color:#8b949e;user-select:none}
</style>
</head>
<body>
<div id="output"></div>
<div id="input-row"><span id="prompt">kerai&gt;</span><input id="input" autofocus autocomplete="off" spellcheck="false"></div>
<div id="status"><span id="status-notation">infix</span><span id="status-right">ker.ai</span></div>
<script>
(function(){
const output=document.getElementById('output');
const input=document.getElementById('input');
const statusNotation=document.getElementById('status-notation');
let notation='infix';
let history=[];
let histIdx=-1;
let savedInput='';

const NOTATION_MAP={
  '.pre':'prefix','.prefix':'prefix','.b':'prefix',
  '.in':'infix','.infix':'infix','.c':'infix',
  '.post':'postfix','.postfix':'postfix','.a':'postfix'
};

function appendLine(text,cls){
  const el=document.createElement('div');
  el.className=cls;
  el.textContent=text;
  output.appendChild(el);
  output.scrollTop=output.scrollHeight;
}

function setNotation(n){
  notation=n;
  statusNotation.textContent=n;
}

async function sendEval(expr){
  try{
    const res=await fetch('/api/eval',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({input:expr,notation:notation})
    });
    const data=await res.json();
    appendLine(data.output,data.error?'line-error':'line-output');
  }catch(e){
    appendLine('error: network request failed','line-error');
  }
}

async function handleSubmit(){
  const raw=input.value;
  input.value='';
  histIdx=-1;
  const trimmed=raw.trim();
  if(!trimmed)return;

  // Push to history
  if(history.length===0||history[history.length-1]!==trimmed){
    history.push(trimmed);
  }

  appendLine('kerai> '+trimmed,'line-input');

  // Local commands
  if(trimmed==='exit'||trimmed==='quit'){
    appendLine('Use Ctrl-D or close the tab to exit.','line-info');
    return;
  }
  if(trimmed==='clear'){
    output.innerHTML='';
    return;
  }
  if(trimmed==='help'){
    appendLine('Notation modes: .pre .in .post (or .prefix .infix .postfix)','line-info');
    appendLine('Operators: + - * / %','line-info');
    appendLine('Literals: integers, floats, hex (0xFF)','line-info');
    appendLine('Commands: clear, help, exit','line-info');
    return;
  }

  // Check for notation switch
  const parts=trimmed.split(/\s+/);
  const first=parts[0];
  if(NOTATION_MAP[first]){
    setNotation(NOTATION_MAP[first]);
    const rest=parts.slice(1).join(' ').trim();
    if(!rest){
      appendLine('notation: '+notation,'line-info');
      return;
    }
    await sendEval(rest);
    return;
  }

  await sendEval(trimmed);
}

input.addEventListener('keydown',function(e){
  if(e.key==='Enter'){
    e.preventDefault();
    handleSubmit();
  }else if(e.key==='ArrowUp'){
    e.preventDefault();
    if(history.length===0)return;
    if(histIdx===-1){
      savedInput=input.value;
      histIdx=history.length-1;
    }else if(histIdx>0){
      histIdx--;
    }
    input.value=history[histIdx];
  }else if(e.key==='ArrowDown'){
    e.preventDefault();
    if(histIdx===-1)return;
    if(histIdx<history.length-1){
      histIdx++;
      input.value=history[histIdx];
    }else{
      histIdx=-1;
      input.value=savedInput;
    }
  }else if(e.key==='l'&&e.ctrlKey){
    e.preventDefault();
    output.innerHTML='';
  }
});

// Focus input on click anywhere
document.addEventListener('click',function(){input.focus()});

// Welcome
appendLine('ker.ai â€” interactive calculator','line-info');
appendLine('Type an expression, e.g. 3 + 4 * 2','line-info');
appendLine('Switch notation: .pre .in .post | Commands: help, clear','line-info');
appendLine('','line-info');
})();
</script>
</body>
</html>
